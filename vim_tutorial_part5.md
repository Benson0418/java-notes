# Vim基礎教學講義 第五部分：命令模式

## 23 命令模式概述

### 23.1 命令模式特性

- 前面的教學大多集中在 Normal 模式
- 命令模式提供了除了 Normal 模式之外的編輯方式
- **命令模式的操作物件以「行」為基本單位**
- `normal` 和 `global` 指令提供強大的批次行操作

## 24 Ex指令格式

### 24.1 基本語法

```
:[範圍] {Ex指令} [參數]
```

- **`範圍`**：作用的範圍，不給的話預設是本行
- **`Ex指令`**：特殊的指令，適用於 Command 模式
- **`參數`**：後續的參數，視指令而定

### 24.2 基本Ex指令

**一些Ex指令（`[x]` 為暫存器，是可選項）：**

```
:[範圍]delete [x]    刪除範圍中的行（到暫存器 x），可簡寫為 d
:[範圍]yank [x]      複製範圍中的行（到暫存器 x），可簡寫為 y
:[範圍]print         將範圍中行印出來，可簡寫為 p
```

## 25 範圍與位址：指定範圍

### 25.1 位址（Address）

**範圍由一個或兩個位址構成：**`{位址}` 或 `{位址},{位址}`

**位址可以是：**

```
{行號}              行號，如3代表第三行（0代表第一行上面的虛擬行）
$                   最後一行
.                   游標所在行
/{patt}/            下一個patt所在的行
```

**位址可以做加減法：**
- `.+3` 代表游標往下第三行
- `$-3` 代表倒數第4行

### 25.2 位址組合成範圍

**位址組合出範圍（可以混用）：**

| 範圍寫法 | 說明 | 範例指令 |
|----------|------|----------|
| `1,3` | 檔案的1-3行 | `1,3 delete` 刪除1~3行 |
| `., .+4` | 目前~目前往下4行（共5行） | `., .+4 yank` 複製目前~目前往下4行 |
| `$-3,$` | 檔案的最後4行 | `$-3,$ print` 印出檔案的最後4行 |

### 25.3 特殊範圍

```
%               特殊的範圍，代表目前檔案的所有行
'<, '>          視覺模式中選中範圍的開頭和結尾
                （視覺模式下直接按 : 可以直接設定）
```

## 26 行的複製、移動、貼上

### 26.1 基本操作指令

```
:[範圍] copy {位址}     把範圍中的行複製到位址後面
:[範圍] move {位址}     把範圍中的行移動到位址後面
:[位址] put [x]         把暫存器x內容貼上到位址後面
```

**注意：**`0` 作為虛擬行的位址，可以用來將內容插入第一行

### 26.2 範例操作

```
:1,3 copy 5         將1-3行複製到第5行後面
:., .+2 move 10     將目前行到往下2行移動到第10行後面
:0 put a            將a暫存器內容貼上到檔案開頭
```

## 27 Ex指令與Normal模式比較

### 27.1 差異分析

**Ex指令和Normal模式下的編輯操作有區別嗎？**

| 特性 | Normal模式 | Command模式 |
|------|------------|-------------|
| 操作單位 | 字元、單字、句子等 | 以「行」為單位 |
| 游標移動 | 需要移動游標 | 無需移動游標 |
| 操作範圍 | 基於游標位置 | 基於指定範圍 |

### 27.2 基本Ex指令總結

**刪除、複製、印出：**

```
:[範圍] delete [x]      刪除指定範圍的行
:[範圍] yank [x]        複製指定範圍的行
:[範圍] print           印出指定範圍的行
```

**複製、移動、貼上：**

```
:[範圍] copy [位址]     複製行到指定位置
:[範圍] move [位址]     移動行到指定位置
:[位址] put [x]         貼上暫存器內容
```

## 28 批次操作：normal指令

### 28.1 normal指令格式

```
:[範圍]normal {指令}
```

**含義：**對範圍中的所有行執行 Normal 模式下的指令

- 將範圍設定為 `%` 可以對整個檔案的所有行執行

### 28.2 normal指令與重複操作

**`:[範圍] normal` 配合 `.` 指令，效果拔群**

**常用做法：**
1. 先做一次修改操作
2. 再用 `normal` 指令在指定的行上重複操作

**範例：**
```
:5,10 normal .      對第5-10行重複上次修改操作
:% normal A;        在每一行末尾新增分號
```

### 28.3 normal指令與巨集

**`.` 指令只能記錄一次修改，用巨集可以實現記錄多個操作**

```
:[範圍] normal @{暫存器}
```

**常用做法：**
1. 先把想要的操作錄製成巨集
2. 再用 `normal` 指令在指定的行上重播巨集

**範例：**
```
:1,100 normal @a    對第1-100行執行a暫存器中的巨集
```

## 29 批次操作：global指令

### 29.1 global指令格式

```
:[範圍]global/{模式}/{指令}
```

**含義：**對範圍中包含模式的所有行執行 Command 模式下的 Ex 指令

- **`指令`**：Ex指令，不給的話預設是印出（print）
- **注意**：`normal` 指令也是 Ex 指令！

### 29.2 global指令範例

```
:global/TODO/delete                     刪除所有帶 TODO 的行
:% global/function/print                印出所有包含 function 的行
:global/TODO/normal A  // 已完成       在所有 TODO 行末尾新增註解
```

### 29.3 global與normal結合

```
:[範圍] global/{模式}/normal {指令}
```

對範圍中所有帶模式的行，執行 Normal 模式下的指令

**範例：**
```
:% global/TODO/normal dd        刪除所有包含 TODO 的整行
:global/function/normal >>      對所有包含 function 的行增加縮排
```

## 30 替換指令

### 30.1 替換指令格式

```
:[範圍]s/{模式}/{字串}/[旗標]
```

**含義：**將模式替換為字串

### 30.2 替換旗標

```
g           替換每一行的所有匹配
i           忽略大小寫
c           替換前進行確認
n           計數而不是替換
```

### 30.3 替換指令範例

```
:%s/Vim/Neovim/g                將檔案中所有 Vim 替換為 Neovim
:1,10s/old/new/gc               在1-10行中將 old 替換為 new，每次確認
:%s/Vim//gn                     統計檔案中所有 Vim 出現的次數
                                （加了 n 就不會執行替換操作）
```

## 小結

- 了解常見的 Ex 指令
- 了解位址和範圍的概念
- **（重要）**掌握如何使用 `normal` 指令批次執行 Normal 模式的指令
- **（重要）**掌握如何使用 `global` 指令批次執行 Command 模式的 Ex 指令
- 掌握替換指令的使用方法